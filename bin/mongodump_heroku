#!/usr/bin/env node
// Generated by LiveScript 1.4.0
(function(){
  var fs, levn, mongoUri, exec, datecmd, curdate, herokusite, dumpdir, mongourl, listcollections, all_collections, mkexport, i$, len$, collection;
  fs = require('fs');
  levn = require('levn');
  mongoUri = require('mongo-uri');
  exec = require('shelljs').exec;
  datecmd = 'date';
  if (fs.existsSync('/usr/local/bin/gdate')) {
    datecmd = '/usr/local/bin/gdate';
  }
  curdate = exec(datecmd + ' --rfc-3339=seconds').output.split(' ').join('_').trim();
  herokusite = process.argv[2];
  if (herokusite == null) {
    console.log('need to provide herokusite');
    process.exit();
  }
  herokusite = herokusite.split('.herokuapp.com').join('');
  dumpdir = [herokusite, curdate].join('_');
  mongourl = exec("heroku config:get MONGODB_URI --app " + herokusite).output.trim();
  if (mongourl === '') {
    mongourl = exec("heroku config:get MONGOLAB_URI --app " + herokusite).output.trim();
  }
  console.log('mongourl: ' + mongourl);
  if (mongourl.indexOf('mongodb://') !== 0) {
    console.log('mongourl does not begin with mongodb://');
    process.exit();
  }
  listcollections = function(uri){
    var login, host, db, user, passwd;
    login = mongoUri.parse(uri);
    host = login['hosts'][0] + ':' + login['ports'][0];
    db = login['database'];
    user = login['username'];
    passwd = login['password'];
    return levn.parse('[String]', exec("mongo --username " + user + " --password " + passwd + " " + (host + '/' + db) + " --eval 'db.getCollectionNames()'").output.trim().split('\n').filter(function(x){
      return x.indexOf('MongoDB shell version') === -1 && x.indexOf('connecting to:') === -1;
    }).join('\n'));
  };
  console.log('collections:');
  all_collections = listcollections(mongourl);
  console.log(all_collections);
  if (all_collections.length === 0) {
    console.log('no collections to dump');
    process.exit();
  }
  mkexport = function(uri, collection){
    var login, host, db, user, passwd;
    login = mongoUri.parse(uri);
    host = login['hosts'][0] + ':' + login['ports'][0];
    db = login['database'];
    user = login['username'];
    passwd = login['password'];
    return exec('mongodump -h ' + host + ' -d ' + db + ' -u ' + user + ' -p ' + passwd + " -c " + collection + " -o '" + dumpdir + "'");
  };
  for (i$ = 0, len$ = all_collections.length; i$ < len$; ++i$) {
    collection = all_collections[i$];
    mkexport(mongourl, collection);
  }
}).call(this);
