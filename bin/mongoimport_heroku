#!/usr/bin/env node
// Generated by LiveScript 1.4.0
(function(){
  var fs, mongoUri, sysexec, glob, exec, herokusite, mongourl, dumpdir, mkrestore, i$, ref$, len$, dbpath, slice$ = [].slice;
  fs = require('fs');
  mongoUri = require('mongo-uri');
  sysexec = require('sysexec');
  glob = require('glob');
  exec = require('shelljs').exec;
  herokusite = process.argv[2];
  if (herokusite == null) {
    console.log('need to provide herokusite');
    process.exit();
  }
  herokusite = herokusite.split('.herokuapp.com').join('');
  mongourl = exec("heroku config:get MONGODB_URI --app " + herokusite).output.trim();
  if (mongourl === '') {
    mongourl = exec("heroku config:get MONGOLAB_URI --app " + herokusite).output.trim();
  }
  console.log('mongourl: ' + mongourl);
  dumpdir = process.argv[3];
  if (dumpdir == null) {
    console.log('need to provide dumpdir');
    process.exit();
  }
  if (!fs.existsSync(dumpdir)) {
    console.log('dumpdir does not exist: ' + dumpdir);
    process.exit();
  }
  mkrestore = function(uri, dumppath){
    var login, host, db, user, passwd, collection;
    login = mongoUri.parse(uri);
    host = login['hosts'][0] + ':' + login['ports'][0];
    db = login['database'];
    user = login['username'];
    passwd = login['password'];
    collection = slice$.call(dumppath.split('/'), -1)[0].split('.json').join('');
    console.log("mongoimport --jsonArray --upsert --host " + host + " --db " + db + " --collection " + collection + " --file " + dumppath);
    return exec("mongoimport --jsonArray --upsert --host " + host + " --db " + db + " --collection " + collection + " --file " + dumppath);
  };
  for (i$ = 0, len$ = (ref$ = glob.sync(dumpdir + '/*.json')).length; i$ < len$; ++i$) {
    dbpath = ref$[i$];
    console.log(dbpath);
    mkrestore(mongourl, dbpath);
  }
}).call(this);
